@page "/image-to-text"
@attribute [Authorize]
@using TraduxAI.Client.Models
@using TraduxAI.Client.Services
@using TraduxAI.Client.Components
@inject IDocumentProcessingService DocumentService
@inject IJSRuntime JSRuntime
@inject IAuthService AuthService

<h3 class="fw-bold">ImageToText</h3>

<div class="row">
	<div class="col-md-6">
		<FileUpload Accept="image/*" OnFileSelected="HandleImageSelected" />

		@if (!string.IsNullOrEmpty(PreviewUrl))
		{
			<div class="mb-3">
				<img src="@PreviewUrl" class="img-fluid border rounded" alt="Selected image" />
			</div>
		}
		<input type="submit" class="btn btn-success" value="Execute imag to text" onclick="@ProcessImage" disabled="@(SelectedFile == null || IsProcessing)" />		
		@if (IsProcessing)
		{
			<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
			<span>Processing...</span>
		}
	</div>

	<div class="col-md-6">
		<div class="mb-3">
			<label class="form-label fw-bold">Extracted Text</label>
			<textarea class="form-control" rows="10" @bind="ExtractedText" readonly />
		</div>
	</div>
	@if (!string.IsNullOrEmpty(ExtractedText))
	{
		<button class="btn btn-secondary" @onclick="CopyToClipboard">Copy to Clipboard</button>
	}
</div>

@code {
	private IBrowserFile? SelectedFile;
	private string? PreviewUrl;
	private string ExtractedText = string.Empty;
	private bool IsProcessing = false;


	private async Task HandleImageSelected(IBrowserFile file)
	{
		SelectedFile = file;
		ExtractedText = string.Empty;
		// Para la vista previa: leer el archivo y convertir a base64
		using var stream = file.OpenReadStream(file.Size);
		using var ms = new MemoryStream();
		await stream.CopyToAsync(ms);
		PreviewUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(ms.ToArray())}";
	}
	private async Task ProcessImage()
	{
		if (SelectedFile == null) return;

		IsProcessing = true;
		try
		{
			var token = await WaitForToken();
			using var stream = SelectedFile.OpenReadStream(10 * 1024 * 1024);
			using var ms = new MemoryStream();
			await stream.CopyToAsync(ms);
			var imageBytes = ms.ToArray();

			var result = await DocumentService.ProcessImageToTextAsync(imageBytes, token);
			ExtractedText = result.ProcessedContent;
		}
		catch (Exception ex)
		{
			ExtractedText = $"Error: {ex.Message}";
		}
		finally
		{
			IsProcessing = false;
		}
	}

	private async Task CopyToClipboard()
	{
		await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", ExtractedText);
	}

	private async Task<string> WaitForToken()
	{
		for (int i = 0; i < 10; i++)
		{
			await Task.Delay(1000);
			var token = await AuthService.GetTokenAsync();
			if (!string.IsNullOrEmpty(token)) return token;

			await Task.Delay(1000);
		}

		throw new Exception("Token Jwt No disponible despues de esperar");
	}
}
